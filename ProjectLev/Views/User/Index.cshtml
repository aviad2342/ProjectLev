

@section User{

    <link href="@Url.Content("~/assets/css/users.css")" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.2.1/css/buttons.bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.2.0/css/select.bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.1.0/css/responsive.dataTables.min.css">
    <link href="~/assets/css/datatables/editor.bootstrap.min.css" rel="stylesheet" />
    <link href="~/Content/bootstrap-rtl.css" rel="stylesheet" />
}

@{
    ViewBag.Title = "User";
}

<div class="row">
    <div class="col-lg-12">


        <div class="box">
            <div class="box-header">
                <h3 class="box-title">טבלת משתמשים</h3>
            </div>

            <!-- Button trigger modal -->
            <button id="btnAdd" class="btn btn-default btn-sm" data-toggle="modal" data-target="#addUserModal">
                <i class="fa fa-user"></i>
                הוספה
            </button> 
            <button id="btnUpdate" class="btn btn-default btn-sm" data-toggle="modal" data-target="#updateUserModal">
                <i class="fa fa-user"></i>
                עדכון
            </button> 
            <button id="btnRemove" class="btn btn-default btn-sm" data-toggle="modal" data-target="#removeUserModal">
                <i class="fa fa-user"></i>
                מחיקה
            </button> 
            
            <!-- Data Tabel -->
            <div class="box-body">
                <div id="example2_wrapper" class="dataTables_wrapper form-inline dt-bootstrap">
                    <div class="row"><div class="col-sm-6"></div><div class="col-sm-6"></div></div><div class="row">
                        <div class="col-sm-12">
                            <table id="example" class="table table-striped table-bordered dataTable" cellspacing="0">
                                <thead>
                                    <tr>
                                        <th>מזהה</th>
                                        <th>שם מלא</th>
                                        <th>אימייל</th>
                                        <th>הרשאות</th>
                                        <th>כתובת</th>
                                        <th>תמונה</th>
                                    </tr>
                                </thead>
                                <tfoot>
                                    <tr>
                                        <th>מזהה</th>
                                        <th>שם מלא</th>
                                        <th>אימייל</th>
                                        <th>הרשאות</th>
                                        <th>כתובת</th>
                                        <th>תמונה</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.box-body -->
        </div>
    </div>
</div>


<!-- Remove Confirm Modal -->
<div class="modal fade" id="removeUserModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                אישור מחיקה
            </div>
            <div class="modal-body">
               האם אתה בטוח שברצונך למחוק רשומה זו?
            </div>
            <div class="modal-footer">
                <button id="btnCancelRemove" type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <a id="btnConfirmRemove" class="btn btn-danger btn-ok">Delete</a>
            </div>
        </div>
    </div>
</div>


      <!-- Modal add user -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog"
     aria-labelledby="addUserLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="addUserLabel">
                    <i class="fa fa-user"></i>
                    טופס הוספת משתמש
                </h4>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">

                <form id="registerForm">
                    <div class="form-group has-feedback">
                        <input class="form-control" id="personId" name="personId" type="number" placeholder="הכנס תעודת זהות">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="userFullname" name="userFullname" type="text" placeholder="הכנס שם מלא">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="userEmail" name="userEmail" type="text" placeholder="הכנס אימייל">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="userPrivileges" name="userPrivileges" type="text" placeholder="הכנס משהו">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="userAddress" name="userAddress" type="text" placeholder="הכנס כתובת">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="profilePic" name="profilePic" type="file" placeholder="בחר תמונת פרופיל">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input id="userPassword" name="userPassword" type="password" placeholder="הזן סיסמה" class="form-control">
                        <span class="glyphicon glyphicon-lock form-control-feedback"></span>
                    </div>
                    <div class="row">
                        <!-- /.col -->
                        <div class="col-xs-6 pull-right">
                            <button id="Submit" type="submit" class="btn btn-primary btn-block btn-flat">הוסף משתמש</button>
                        </div>
                        <!-- /.col -->
                    </div>
                </form>


            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button id="btnCloseAddForm" type="button" class="btn btn-default"
                        data-dismiss="modal">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>


      <!-- Modal update user -->
<div class="modal fade" id="updateUserModal" tabindex="-1" role="dialog"
     aria-labelledby="addUserLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <button type="button" class="close"
                        data-dismiss="modal">
                    <span aria-hidden="true">&times;</span>
                    <span class="sr-only">Close</span>
                </button>
                <h4 class="modal-title" id="addUserLabel">
                    <i class="fa fa-user"></i>
                    טופס עדכון משתמש
                </h4>
            </div>

            <!-- Modal Body -->
            <div class="modal-body">

                <form id="updateForm">
                    <div class="form-group has-feedback">
                        <input class="form-control" id="personIdU" name="personIdU" type="number" placeholder="הזן תעודת זהות">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="userFullnameU" name="userFullnameU" type="text" placeholder="הזן שם מלא">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="userEmailU" name="userEmailU" type="text" placeholder="הזן אימייל">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="userPrivilegesU" name="userPrivilegesU" type="text" placeholder="הזן משהו">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="userAddressU" name="userAddressU" type="text" placeholder="הכנס כתובת">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="form-group has-feedback">
                        <input class="form-control" id="profilePicU" name="profilePicU" type="text">
                        <span class="glyphicon glyphicon-envelope form-control-feedback"></span>
                    </div>
                    <div class="row">
                        <!-- /.col -->
                        <div class="col-xs-6 pull-right">
                            <button id="SubmitUpdate" type="submit" class="btn btn-primary btn-block btn-flat">עדכן משתמש</button>
                        </div>
                        <!-- /.col -->
                    </div>
                </form>


            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button id="btnCloseUpdateForm" type="button" class="btn btn-default"
                        data-dismiss="modal">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>


@section scripts {

<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.12/js/dataTables.bootstrap.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.2.1/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.2.1/js/buttons.bootstrap.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/select/1.2.0/js/dataTables.select.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/responsive/2.1.0/js/dataTables.responsive.min.js"></script>

    <script>

        var selectedRow;
        $(document).ready(function () {

            $('#btnUpdate').attr("disabled", true);
            $('#btnRemove').attr("disabled", true);
            $('#personIdU').attr("disabled", true);
            $('#profilePicU').attr("disabled", true);
            
            var table = $('#example').DataTable({
                lengthChange: false,
                responsive: true,
                ajax: {
                    "url": "User/GetUsers",
                    "dataSrc": ""
                },
                columns: [
                    //{
                    //    data: null, render: function (data, type, row) {
                    //        // Combine the first and last names into a single table field
                    //        return data.fullName;
                    //    }
                    //},
                    { data: "personID" },
                    { data: "fullName" },
                    { data: "email" },
                    { data: "privileges" },
                    { data: "userAddress" },
                    { data: "profilePic" }
                ],
                select: true
            });

            // selected row event
            $('#example tbody').on('click', 'tr', function () {
                selectedRow = table.row(this).data();
                isSelectedRow();
            });

            // chack if a row was selected
            function isSelectedRow() {
                if (table.rows({ selected: false }).count() > 0) {
                    $('#btnUpdate').attr("disabled", true);
                    $('#btnRemove').attr("disabled", true);
                }

                if (table.rows({ selected: true }).count() > 0) {
                    $('#btnUpdate').attr("disabled", false);
                    $('#btnRemove').attr("disabled", false);
                }
            };

            // update selected row event
            $('#btnUpdate').click(function () {
                $('#personIdU').val(selectedRow.personID);
                $('#userFullnameU').val(selectedRow.fullName);
                $('#userEmailU').val(selectedRow.email);
                $('#userPrivilegesU').val(selectedRow.privileges);
                $('#userAddressU').val(selectedRow.userAddress);
                $('#profilePicU').val(selectedRow.profilePic);
            });

            /* JQUERY Validations */
            jQuery.validator.setDefaults({
                debug: true,
                success: "valid"
            });

            // Validations Regex contain only letters and numbers
            $.validator.addMethod("lNnRegex", function (value, element) {
                return this.optional(element) || /^([a-zA-Z0-9]+)$/.test(value);
            }, "Username must contain only letters and numbers");

            // Validations Regex contain at least 1 letter and 1 number
            $.validator.addMethod("onelnRegex", function (value, element) {
                return this.optional(element) || /[a-z].*[0-9]|[0-9].*[a-z]/i.test(value);
            }, "Username must contain at least 1 letter and 1 number");

            //------------------------------------------------------ Modal add user -------------------------------------------------

            $('#registerForm').validate({
                rules: {
                    personId: {
                        required: true,
                        minlength: 9,
                        maxlength: 9
                    },
                    userEmail: {
                        required: true,
                        email: true
                    },
                    userFullname: {
                        required: true
                    },
                    userPassword: {
                        required: true,
                        lNnRegex: true,
                        onelnRegex: true,
                        minlength: 3,
                        maxlength: 10
                    }
                },
                messages: {
                    personId: {
                        required: "שדה זה הינו שדה חובה!",
                    },
                    userEmail: {
                        required: "שדה זה הינו שדה חובה!",
                    },
                    userFullname: {
                        required: "שדה זה הינו שדה חובה!",
                    },
                    password: {
                        required: "שדה זה הינו שדה חובה!",
                        minlength: "הסיסמה חייבת להכיל 3 אותיות לפחות!"
                    }
                },
                highlight: function (element) {
                    $(element).closest('.form-group').addClass('has-error');

                },
                unhighlight: function (element) {
                    $(element).closest('.form-group').removeClass('has-error');
                },
                errorElement: 'span',
                errorClass: 'help-block',
                errorPlacement: function (error, element) {
                    if (element.parent('.input-group').length) {
                        error.insertAfter(element.parent());
                    } else {
                        error.insertAfter(element);
                    }
                },
                submitHandler: function (form) {
                    // on success
                    $.ajax({
                        url: '@Url.Action("addUser", "User")',
                        type: "POST",
                        dataType: "json",
                        data: {
                            personId: $('#personId').val().toString(),
                            userFullname: $('#userFullname').val(),
                            userEmail: $('#userEmail').val(),
                            userPrivileges: $('#userPrivileges').val(),
                            userAddress: $('#userAddress').val(),
                            profilePic: $('#profilePic').val(),
                            userPassword: $('#userPassword').val()
                        },
                        success: function (result) {
                            if (result != "error") {
                                $('#addUserModal').modal('hide');
                                table.row.add({
                                    "personID": result.personID,
                                    "fullName": result.fullName,
                                    "email": result.email,
                                    "privileges": result.privileges,
                                    "profilePic": result.profilePic,
                                    "userAddress": result.userAddress,
                                    "userPassword": result.userPassword
                                }).draw();
                            }
                        },
                        error: function (result) {
                            alert("Failed");
                        }
                    });
                }

            })

            //------------------------------------------------------ update user -------------------------------------------------

            $('#updateForm').validate({
                rules: {
                    personIdU: {
                        required: true
                    },
                    userEmailU: {
                        required: true,
                        email: true
                    },
                    userFullnameU: {
                        required: true
                    }
                },
                messages: {
                    personIdU: {
                        required: "שדה זה הינו שדה חובה!",
                    },
                    userEmailU: {
                        required: "שדה זה הינו שדה חובה!",
                    },
                    userFullnameU: {
                        required: "שדה זה הינו שדה חובה!",
                    }
                },
                highlight: function (element) {
                    $(element).closest('.form-group').addClass('has-error');

                },
                unhighlight: function (element) {
                    $(element).closest('.form-group').removeClass('has-error');
                },
                errorElement: 'span',
                errorClass: 'help-block',
                errorPlacement: function (error, element) {
                    if (element.parent('.input-group').length) {
                        error.insertAfter(element.parent());
                    } else {
                        error.insertAfter(element);
                    }
                },
                submitHandler: function (form) {
                    // on success
                    $.ajax({
                        url: '@Url.Action("updateUser", "User")',
                        type: "POST",
                        dataType: "json",
                        data: {
                            personId: $('#personIdU').val(),
                            userFullname: $('#userFullnameU').val(),
                            userEmail: $('#userEmailU').val(),
                            userPrivileges: $('#userPrivilegesU').val(),
                            userAddress: $('#userAddressU').val(),
                            profilePic: $('#profilePicU').val()
                        },
                        success: function (result) {
                            if (result != "error") {
                                $('#updateUserModal').modal('hide');
                                table.row('.selected').remove().draw();

                                table.row.add({
                                    "personID": result.personID,
                                    "fullName": result.fullName,
                                    "email": result.email,
                                    "privileges": result.privileges,
                                    "userAddress": result.userAddress,
                                    "profilePic": result.profilePic

                                }).draw();
                            }

                            isSelectedRow();
                        },
                        error: function (result) {
                            alert("Failed");
                        }
                    });
                }

            });

            $('#btnCloseUpdateForm').click(function () {
                table.row('.selected').deselect().draw();
                isSelectedRow();
            });

//------------------------------------------------------ remove user -------------------------------------------------

            $('#btnConfirmRemove').click(function () {
                $.ajax({
                    url: '@Url.Action("removeUser", "User")',
                    type: "POST",
                    dataType: "json",
                    data: {
                        personId: selectedRow.personID,
                    },
                    success: function (result) {
                        if (result != "error") {
                            $('#removeUserModal').modal('hide');
                            table
                                .row('.selected')
                                .remove()
                                .draw();
                        }
                        isSelectedRow();
                    },
                    error: function (result) {
                        alert("Failed");
                    }
                });
            });

            $('#btnCancelRemove').click(function () {
                table.row('.selected').deselect().draw();
                isSelectedRow();
            });

        });


        /*$('#pictureRequest').click(function () {
            $('#pictureRequest').val("");
        });

        $('#pictureRequest').change(function () {

            alert($('#pictureRequest').val());
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#pp').attr('src', e.target.result);
            }

            reader.readAsDataURL(this.files[0]);
        });*/

    </script>

}

